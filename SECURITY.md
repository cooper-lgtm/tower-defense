# SECURITY

## 客户端不可信前提下的校验
- 关卡一致性：提交成绩时强制校验 `level_version` 与服务端当前关卡文件的 `version`/`hash`，避免客户端篡改配置后上传成绩。
- 身份限制：仅注册用户可上传成绩，guest 仅试玩不入榜。
- 榜单去重：同一用户同关卡仅保留最高分，分数相同取耗时更短；重复提交不会无限膨胀榜单。
- 成绩签名：客户端用共享密钥对 `level_id|level_version|level_hash|score|wave|time_ms|life_left|timestamp|nonce|ops_digest` 做 HMAC-SHA256，附带 `timestamp`（秒级）和一次性 `nonce`；服务端验证签名、2 分钟时间窗、nonce 去重（Redis 优先，内存回退）。防止篡改分数或重复重放旧包。

## 服务端判定入榜策略
- 请求内完整流程：校验通过 → 创建 Score 记录并 commit（Postgres 权威存储）→ 构造 `LeaderboardEntry` → 调用 `Leaderboard.submit` 更新榜单视图。
- Redis 模式（可用时优先）：
  - Member 为 user_id（字符串），score 为 ZSET 分值。
  - 若同用户已有分值，仅在新分更高或同分耗时更短时覆盖。
  - payload 详细字段存入 hash（key`:payloads`）以便读取时还原波次/耗时等。
  - `zremrangebyrank` 截断到 `leaderboard_size`，避免无限增长。
- 内存回退（Redis 不可用时）：
  - 进程内列表，按分数降序、耗时升序去重截断，逻辑与 Redis 分支一致，但不持久、不跨进程。
  - 仅用于降级保障功能，不作为权威来源。  

## 防重放/防刷榜（现状与建议）
- 现状
  - JWT 鉴权 + 版本/hash 校验 + HMAC 签名 + 2 分钟时间窗 + nonce 去重，防篡改/防重放。
  - 最高分去重策略，让重复提交价值有限。
  - 尚未校验操作轨迹或数值上界，仍可能伪造极端高分。
- 建议增强（可迭代）
  1) **操作轨迹摘要**（ops_digest）：客户端对战斗操作序列做哈希；服务端抽样重放或做规则校验（波次上限、最短时间、塔数量/伤害上界）。
  2) **数值合理性校验**：根据关卡与经济上限估算最大理论分/最短时间，超阈值拒绝或标记复查。
  3) **频率限制与风控**：对单用户/IP 提交频次做限制，异常模式报警。
  4) **密钥管理**：签名密钥定期轮换、分版本灰度；泄露时快速替换。
  5) **服务端关卡白名单**：仅接受已知 `level_id` 的提交，避免伪造关卡名。

## 局限性与应对
- 客户端被逆向仍可生成合法签名：需要密钥轮换、风控、操作摘要或远程验证来提高造假成本。
- 内存榜单回退不持久：生产环境应确保 Redis 可用或落盘。
- 目前未做速率/数值上界校验：可按建议逐步补充。  
