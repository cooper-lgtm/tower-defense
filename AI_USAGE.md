# 关于塔防游戏的设计

关于旧的塔防游戏

一、规则是怎么设计的?
1、关于怪物不能经过障碍和炮塔这个点, 是怎么设计的?
2、关于等级和怪物的血量这个是怎么设计的? 
3、每一波出现的怪物数量和怪物血量怎么设计的? 
4、每个怪物的颜色, 和它们的能力或者叫血量有什么关系吗?
5、每个怪物所给的金币数量, 是怎么定的?

排行榜这里, 真有意思, 使用Redis Sorted SET
要做Redis sub/pub, 因为我们多进程, 广播让各个webSocket去重新获取排名


关于新的塔防游戏(架构)

前端(客户端): TypeScript + Vite + Canvas
通信使用REST, webSocket.
移动端适配通过 DPR 缩放与 Touch 事件抽象；
渲染资源统一使用 Texture Atlas；
音频层使用 Web Audio API。

后端: web框架: FastAPI(python), 运行web服务的生产级组合: gunicorn + uvicorn worker. (uvicorn跑FastAPI, gunicorn管理多进程)
网络层: Nginx
存储: PostgreSQL
缓存: Redis
异步: RQ（Redis Queue）
实时: FastAPI WebSocket (服务端和客户端通信, 多worker的推送出口), Redis Pub/Sub (广播, 让WS 通知客户端更新排行榜)
排行榜: Redis ZSET
部署: Docker Compose

**游戏设计方案**

- 模式与节奏：无尽模式（Endless）唯一模式；开局建造期（可跳过），整波刷新，无“半波”；支持暂停/快进（1x/2x）。
- 地图与关卡配置：网格默认 16×16，可扩展；入口/出口坐标；禁行/禁建格；预置塔列表；初始金币/生命。配置 JSON 附 version 和 hash，客户端回传校验。
- 波次与难度：前 N 波固定表（[[count, type], ...]），超过后自动生成：数量≈pow(wave,1.1)，上限 maxPerWave，类型权重随波次变化；动态难度 difficulty：上一波损失少则提升，多则回调，用于放大 hp/armor/speed/dmg/reward。
- 塔（基础 4+1）：Cannon（中程中伤）、LMG（远程低伤高攻速）、HMG（近中程高伤中速）、Laser（中远程高伤瞬时命中）、Wall（阻挡无攻）。1–5 级，造价递增，出售返还 50%，显示射程圈，预建模式高亮可建格。
- 怪物（基础 6 类）：Normal、Fast、Tank、Shield、Bruiser、Boss（每 10 波）；属性实例化按 difficulty × 随机因子 (0.8~1.2) 调 hp/armor/speed/dmg/reward；颜色固定对应类型；路径用网格寻路（A*/Dijkstra 4 邻居），同长路径随机选，堵路检测禁止建造。
- 经济与评分：金币=初始+击杀奖励+波次奖励（随波次递增）；生命由漏怪扣；评分基于波次/难度/用时/剩余生命/击杀，上传成绩含关卡 hash。
- 客户端体验：射程/预建预览、阻塞提示、波次预告、错误提示（金不足/堵路）、低配模式可关特效；鼠标/触摸统一；DPR 适配。

**前端架构（TypeScript + Vite + Canvas 任选）**

- 核心循环：固定步 update(dt) + render()，逻辑/渲染分离；状态机 menu/building/running/paused/gameover。
- 模块：资源加载（Texture Atlas，Web Audio）、输入抽象（鼠标/触摸）、网格地图、塔/怪/子弹/特效、寻路、UI 覆盖层（可用轻量 DOM 层）。
- 数据驱动：关卡/塔/怪/波次配置 JSON；全局只读常量，便于热更新和平衡。
- 防作弊基础：关键配置只读；成绩提交携带配置 hash + 签名/摘要（可选操作回放）；接口限频。

**后端架构（FastAPI + gunicorn/uvicorn + Postgres + Redis + RQ）**

- API（REST）：
    - POST /auth/login → JWT
    - GET /levels/{id} → 配置+version+hash（当前仅 endless, 获取版本更新, 作为整局的配置）
    - GET /leaderboard?level=endless&scope=all → Top N（先做总榜）
    - POST /score → {score, wave, time_ms, life_left, level_version, level_hash, signature/ops_digest}，同步校验后入库+入榜
- 实时：FastAPI WebSocket /ws/leaderboard 推送榜单更新；Redis Pub/Sub 广播给多 worker。
- 数据模型（Postgres）：users(id, name, hash_pwd, created_at)；levels(id, config_json, version, hash)；scores(id, user_id, level_id, score, wave, time_ms, life_left, created_at)。
- Redis 用途：ZSET 榜单（全服 Top10 或更多），限频/会话缓存，RQ 队列（异步任务）。
- 校验与安全：JWT 鉴权；成绩参数范围校验 + 签名/限频；必要时异步复算；HTTPS/Nginx 终止 TLS。
- 部署：Docker Compose（web、db、redis、worker、nginx），gunicorn 多 worker（uvicorn worker），nginx 反代/静态。

**落地优先级（MVP）**

1. 前端：基础地图+建塔/升级/出售+波次刷新+怪物行走/击杀/漏怪+暂停/快进；配置从本地 JSON 读取。
2. 后端：登录（可匿名/游客）、GET /levels/endless 返回配置、POST /score 入库+更新 Redis 榜、GET /leaderboard 读榜。
3. 资源与适配：DPR、触摸支持、基础音效；Texture Atlas/SpriteSheet 结构定好。
4. 防作弊基础：签名/限频、配置 hash 回传；后续再加操作摘要/复算。


Version 1.0

有几个问题, 
1、我目前的代码中, 排行榜有具体的展示界面吗? 还是在主界面有展示的组件? 目前的界面看不到排行榜相关的内容.
2、我运行了项目, 但是感觉前端并没有和后端通信, 没有API访问, 后端没有任何相应. 什么问题?
3、我的数据库postgreSql, 是不是需要在后端执行时, 相关数据库以及表结构要完成创建? 现在有吗? 
4、redis相关的应用有启动吗? 目前看到任何redis相关的操作
5、关于前端, 问题很多. 我们约定的多种武器, 目前我就只能看到蓝色方块, 看不到具体武器的图标, 看不到武器选择的地方
6、并且有个问题, 如果我的武器, 是在这一波中建造的, 那这怪物其实还是能穿过武器, 只有在这一波开始前创建的武器怪物才不会穿过. 
7、我看后端做了登录项, 但是目前没看到相关的内容啊? 你毕竟要做世界排名, 你现在连登录的地方都没有.
8、调整UI的颜色, 调整为白底

version1.1

1、数据库我需要自动建库建表, 后端启动的时候我就需要连接数据库, 检查是否有这个库, 检查表是否存在, 不存在要建表. 这种操作合理吗? 我只是想要部署自动化
2、redis我已经启动了, 其他的怎么做呢?
3、波中建造的防御塔已经不会被穿透了, 但是存在一个现象, 如果我在怪物旁边新建防御塔, 怪物的路径会有一点卡顿, 像是在重新计算路线一样. 没有那么丝滑, 有一点点奇怪.
4、我们既然要做登录, 应该是需要账号密码吧? 如果没有账号密码绑定名称, 怎么确认这个成绩是谁的呢? 新增账号密码登录, 注册时要求名称唯一.
游戏开始前, 先做登录, 登录后才可以开始游戏. 如果以游客的身份玩, 就做一个“游客”, 游客成绩不计入排行榜

version1.2

1、添加 Alembic 迁移/建库脚本，避免依赖 create_all；启动脚本同时拉起 Postgres + Redis。
2、关于登录接口, 你是怎么实现的? 我的想法是客户端只会把user_name, password带着去访问服务端的登录接口, 服务端拿到用户名密码后, 再验证密码是否正确. 这样会安全一些. 目前是这样做的吗?
3、我应该还需要做个注册接口, 注册是需要user_name 和 password. 注册时需要校验user_name是否唯一.
思考下关于注册和登录两个接口, 我这边做的对不对?
进入游戏, 先看到
塔防游戏
登录 注册   这个界面, 没账号就注册, 有账号就登录, 登录后就进入游戏界面, 我还需要一个开始游戏的按钮,

version1.3
1、我想我们的应用, 先展示的是登录页面. 进入应用, 先展示登录界面, 登录界面新增一个游客模式. 游客模式的用户名是guest. 
2、删除游戏页面的登录板块, 按图中所示进行界面UI调整. 原本的开始游戏的按钮移到画布中间, 点击开始游戏按钮后, 游戏才会开始.

version1.4
把排行榜移到左边来, 现在就是三栏式结构, 左边是排行榜, 中间是画布, 下午是用户信息以及防御塔

version1.5
1、新增积分系统, 排行榜是以积分来进行排序
- 每次怪物被击中时，beHit 会累加 TD.score += Math.floor(Math.sqrt(damage))，也就是按本次造成的伤害取平方根再取整累加。
- 怪物被杀死时并不会额外加分，只会掉落金币（TD.money += this.money）。
因此当前积分 = 对怪物造成的伤害总和（经过 sqrt 压缩）之和，而不是按怪物类型预设分值。
2、金币系统调整, 金币只会给整数, 不会给小数的金币. 四舍五入的取整
3、更新武器系统, 现在的武器系统没有价格, 在这边给每个武器标注价格.  现在的武器没有图标, 给武器设计图标. 

version1.6 优化积分系统

1、游戏结束, 屏幕中心展示大字 GAME OVER. 然后自动上传积分, 我们需要用这个积分来进行积分榜排序的. 积分上传, 如果积分靠前, 我们就可以在积分榜看到username.
2、修改菜单UI布局. 把原本展示在画布顶端的怪物波数, 成绩, 金币, 生命, 状态转移到右侧第一个板块, 放在用户下面. 按照图中的方式进行2列布局. 
生命, 状态
成绩, 金币
怪物: 第几波
3、在用户板块和防御塔板块之间, 加一个暂停和重新开始的按钮, 一行放两个按钮. 暂停按钮在游戏进行中时展示暂停, 在游戏暂停时展示继续. 如果游戏结束了, 这个暂停/继续按钮就没用了. 如果想玩可以点击重新开始按钮.

version1.7 优化游戏界面UI
1、鼠标指针有问题, 鼠标指针会出现偏移的情况, 向左上角偏移. 我的实际指针在左上角的小红色方框, 但是UI的指针已经在下面这个大的红色方框了.
2、现在每个防御塔都还是以蓝色方块代替的, 我需要做成具体的防御塔了, 设计这些防御塔的UI图标, 区分开来.
3、部署防御塔, 选择了一个防御塔,  需要在画布上部署, 我需要看到这个防御塔的攻击范围, 是一个圈, 我需要看到这个范围, 每个防御塔的范围不一样. 
4、部署好的防御塔, 我点击这个防御塔, 它会展示它的攻击范围, 并且在该防御塔的右边, 会有一个上下两行的小菜单, 第一行是升级, 第二行是出售

version 1.8
1、关于鼠标操作的问题, 我希望新增Esc按键功能. 目前的鼠标按键, 只能用于部署防御塔, 但是如果我选择了防御塔, 但是我又不想部署的时候, 这里就有问题了, 我没办法取消. 包括点击防御塔后,  我有升级和出售两个选项, 但是这个一旦点出菜单后, 就没办法再取消了, 这里也需要使用Esc可以取消操作.
2、关于防御塔, 我希望它是可以有瞄准动画的. 现在的防御塔就是一个贴图, 炮塔在底层代码中会进行攻击, 但是炮塔不会旋转, UI中不会发射炮弹或者子弹或者激光, 这里我需要进一步优化
3、关于积分上传接口, 有问题**POST /api/score HTTP/1.1**" 500 Internal Server Error

version1.9
这个防御塔的子弹, 以及防御塔的动画, 都有些问题. 加农炮、轻机枪、重机枪发射的是子弹, 只有激光枪发射的是持续的激光. 这里有两个问题, 
1、所有的防御塔, 攻击的方式都是发射一下一下的激光, 这不符合防御塔的设计. 
2、其次防御塔的炮口, 在发射时并没有瞄准怪物, 炮弹不是从炮口发射出来的. 尤其是这个轻机枪和重机枪, 他们多了一个发射口. 子弹并不是从原设定的炮口出来的. 加农炮也是, 激光炮有两个炮口
3、炮塔的转动不够丝滑, 太僵硬了, 瞬间转向. 它应该是有一个转动的过程. 并且在持续攻击中, 应该是边打边转动.
4、排行榜应该记录的是每个人的最高分, 由所有人的最高分进行排序, 取前10个, 现在是把每个分数进行了排序, 取了前十个

基础版本已完成, 开始优化游戏内容, 进入2.0阶段

 version 2.0: 
1、降低怪物的移动速度, 现在的怪物移动太快了, 我需要当前怪物的移速数值, 我要看看该怎么改. 

2、新增一个减速防御塔, 它可以发射减速的炮弹, 被击中的怪物降低50%的移速. 就叫冷冻炮

3、激光炮每提升一个等级, 可以多攻击一个目标, 最多三个, 前三次升级不改变伤害数值, 只增加攻击数量, 三级之后开始加伤害.

4、修改加农炮, 把加农炮做成范围伤害, 这个范围应该不会很大, 主要是处理怪物集中在一起的时候, 现在炮弹只会攻击一个目标, 就算多个目标及在一起, 也只会攻击一个目标, 我该怎么设计这个范围性伤害呢? 范围怎么定呢?